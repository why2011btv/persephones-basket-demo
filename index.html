<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plant Disease Demo — best_model_original.keras</title>
<style>
  :root{
    --bg:#0b0f1a; --panel:#121829; --accent:#6ee7ff; --accent2:#a78bfa;
    --text:#e6edf7; --muted:#95a0b3; --good:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0f1a 0%, #0e1422 100%);
       color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{display:grid;grid-template-columns:280px 1fr 360px;gap:16px;padding:16px;min-height:100vh;}
  .card{background:var(--panel);border:1px solid #1f2a44;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
  .left,.middle,.right{padding:16px}
  .title{font-size:18px;font-weight:700;letter-spacing:.2px;margin:0 0 10px 0}
  .samples{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-height:calc(100vh - 220px);overflow:auto;padding-right:6px}
  .sample{cursor:pointer;border-radius:12px;border:1px solid #1e2744;overflow:hidden;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#0a0f1b;}
  .sample img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .2s ease}
  .sample:hover img{transform:scale(1.03)}
  .upload{margin-top:12px;padding:12px;border:1px dashed #31406b;border-radius:12px;text-align:center;color:var(--muted)}
  .upload input{display:none}
  .btn{cursor:pointer;display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,var(--accent),var(--accent2));
       color:#031222;font-weight:700;padding:10px 14px;border:none;border-radius:10px;}
  .btn:active{transform:translateY(1px)}
  .preview{display:grid;grid-template-columns:400px 1fr;gap:16px;align-items:start;}
  .imgbox{border-radius:16px;overflow:hidden;border:1px solid #223056;background:#0a0f1b;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center}
  .imgbox img{max-width:100%;max-height:100%;display:block}
  .metrics{padding:8px 0}
  .metric{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #233156}
  .bar{height:8px;background:#13203c;border-radius:999px;overflow:hidden;flex:1;margin-left:10px}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .pred{font-size:22px;font-weight:800}
  .sub{color:var(--muted);font-size:12px}
  .footer{margin-top:12px;color:var(--muted);font-size:12px}
  canvas{width:100%;height:calc(100vh - 48px);display:block;border-radius:16px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(110,231,255,.1);color:var(--accent)}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT -->
  <div class="left card">
    <h2 class="title">Sample Images</h2>
    <div class="samples">
      <div class="sample" onclick="useSample('static/samples/0_Apple___Apple_scab.jpg')">
<img src="static/samples/0_Apple___Apple_scab.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/1_Apple___Black_rot.jpg')">
<img src="static/samples/1_Apple___Black_rot.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/2_Apple___Cedar_apple_rust.jpg')">
<img src="static/samples/2_Apple___Cedar_apple_rust.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/3_Apple___healthy.jpg')">
<img src="static/samples/3_Apple___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/4_Blueberry___healthy.jpg')">
<img src="static/samples/4_Blueberry___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/5_Cherry___healthy.jpg')">
<img src="static/samples/5_Cherry___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/6_Cherry___Powdery_mildew.jpg')">
<img src="static/samples/6_Cherry___Powdery_mildew.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/7_Corn___Cercospora_leaf_spot_Gray_leaf_spot.jpg')">
<img src="static/samples/7_Corn___Cercospora_leaf_spot_Gray_leaf_spot.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/8_Corn___Common_rust.jpg')">
<img src="static/samples/8_Corn___Common_rust.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/9_Corn___healthy.jpg')">
<img src="static/samples/9_Corn___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/10_Corn___Northern_Leaf_Blight.jpg')">
<img src="static/samples/10_Corn___Northern_Leaf_Blight.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/11_Grape___Black_rot.jpg')">
<img src="static/samples/11_Grape___Black_rot.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/12_Grape___Esca_(Black_Measles).jpg')">
<img src="static/samples/12_Grape___Esca_(Black_Measles).jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/13_Grape___healthy.jpg')">
<img src="static/samples/13_Grape___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/14_Grape___Leaf_blight_(Isariopsis_Leaf_Spot).jpg')">
<img src="static/samples/14_Grape___Leaf_blight_(Isariopsis_Leaf_Spot).jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/15_Orange___Haunglongbing_(Citrus_greening).jpg')">
<img src="static/samples/15_Orange___Haunglongbing_(Citrus_greening).jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/16_Peach___Bacterial_spot.jpg')">
<img src="static/samples/16_Peach___Bacterial_spot.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/17_Peach___healthy.jpg')">
<img src="static/samples/17_Peach___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/18_Pepper,_bell___Bacterial_spot.jpg')">
<img src="static/samples/18_Pepper,_bell___Bacterial_spot.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/19_Pepper,_bell___healthy.jpg')">
<img src="static/samples/19_Pepper,_bell___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/20_Potato___Early_blight.jpg')">
<img src="static/samples/20_Potato___Early_blight.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/21_Potato___healthy.jpg')">
<img src="static/samples/21_Potato___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/22_Potato___Late_blight.jpg')">
<img src="static/samples/22_Potato___Late_blight.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/23_Raspberry___healthy.jpg')">
<img src="static/samples/23_Raspberry___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/24_Soybean___healthy.jpg')">
<img src="static/samples/24_Soybean___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/25_Squash___Powdery_mildew.jpg')">
<img src="static/samples/25_Squash___Powdery_mildew.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/26_Strawberry___healthy.jpg')">
<img src="static/samples/26_Strawberry___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/27_Strawberry___Leaf_scorch.jpg')">
<img src="static/samples/27_Strawberry___Leaf_scorch.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/28_Tomato___Bacterial_spot.jpg')">
<img src="static/samples/28_Tomato___Bacterial_spot.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/29_Tomato___Early_blight.jpg')">
<img src="static/samples/29_Tomato___Early_blight.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/30_Tomato___healthy.jpg')">
<img src="static/samples/30_Tomato___healthy.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/31_Tomato___Late_blight.jpg')">
<img src="static/samples/31_Tomato___Late_blight.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/32_Tomato___Leaf_Mold.jpg')">
<img src="static/samples/32_Tomato___Leaf_Mold.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/33_Tomato___Septoria_leaf_spot.jpg')">
<img src="static/samples/33_Tomato___Septoria_leaf_spot.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/34_Tomato___Spider_mites_Two-spotted_spider_mite.jpg')">
<img src="static/samples/34_Tomato___Spider_mites_Two-spotted_spider_mite.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/35_Tomato___Target_Spot.jpg')">
<img src="static/samples/35_Tomato___Target_Spot.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/36_Tomato___Tomato_mosaic_virus.jpg')">
<img src="static/samples/36_Tomato___Tomato_mosaic_virus.jpg" alt="sample">
      </div>
      <div class="sample" onclick="useSample('static/samples/37_Tomato___Tomato_Yellow_Leaf_Curl_Virus.jpg')">
<img src="static/samples/37_Tomato___Tomato_Yellow_Leaf_Curl_Virus.jpg" alt="sample">
      </div>
    </div>
    <div class="upload">
      <div style="margin-bottom:8px">Or upload your own image</div>
      <label class="btn">
        <input type="file" id="fileInput" accept="image/*" />
        Choose File
      </label>
    </div>
    <div style="margin-top:12px">
            <span class="pill">38 classes</span>
    </div>
  </div>

  <!-- MIDDLE -->
  <div class="middle card">
    <h2 class="title">Prediction</h2>
    <div class="preview">
      <div class="imgbox"><img id="preview" src="" alt="preview"></div>
      <div>
        <div class="pred" id="predLabel">—</div>
        <div class="sub" id="predProb">—</div>
        <div class="metrics" id="metrics"></div>
        <div class="footer">Tip: click a sample (left) or upload; the visualization (right) will animate to the predicted class.</div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right card">
    <h2 class="title">Neural Network Visualization</h2>
    <canvas id="nn"></canvas>
  </div>
</div>

<script>
  const preview = document.getElementById('preview');
  const fileInput = document.getElementById('fileInput');
  const predLabel = document.getElementById('predLabel');
  const predProb  = document.getElementById('predProb');
  const metricsDiv = document.getElementById('metrics');

  // 类别名
  const CLASS_NAMES = [
    "Apple Apple scab",
    "Apple Black rot",
    "Apple Cedar apple rust",
    "Apple healthy",
    "Blueberry healthy",
    "Cherry healthy",
    "Cherry Powdery mildew",
    "Corn Cercospora leaf spot Gray leaf spot",
    "Corn Common rust",
    "Corn healthy",
    "Corn Northern Leaf Blight",
    "Grape Black rot",
    "Grape Esca (Black Measles)",
    "Grape healthy",
    "Grape Leaf blight (Isariopsis Leaf Spot)",
    "Orange Haunglongbing (Citrus greening)",
    "Peach Bacterial spot",
    "Peach healthy",
    "Pepper, bell Bacterial spot",
    "Pepper, bell healthy",
    "Potato Early blight",
    "Potato healthy",
    "Potato Late blight",
    "Raspberry healthy",
    "Soybean healthy",
    "Squash Powdery mildew",
    "Strawberry healthy",
    "Strawberry Leaf scorch",
    "Tomato Bacterial spot",
    "Tomato Early blight",
    "Tomato healthy",
    "Tomato Late blight",
    "Tomato Leaf Mold",
    "Tomato Septoria leaf spot",
    "Tomato Spider mites Two-spotted spider mite",
    "Tomato Target Spot",
    "Tomato Tomato mosaic virus",
    "Tomato Tomato Yellow Leaf Curl Virus"
  ];

  // 每个 sample 对应的正确标签
  const SAMPLE_LABELS = {
    "static/samples/0_Apple___Apple_scab.jpg": "Apple Apple scab",
    "static/samples/1_Apple___Black_rot.jpg": "Apple Black rot",
    "static/samples/2_Apple___Cedar_apple_rust.jpg": "Apple Cedar apple rust",
    "static/samples/3_Apple___healthy.jpg": "Apple healthy",
    "static/samples/4_Blueberry___healthy.jpg": "Blueberry healthy",
    "static/samples/5_Cherry___healthy.jpg": "Cherry healthy",
    "static/samples/6_Cherry___Powdery_mildew.jpg": "Cherry Powdery mildew",
    "static/samples/7_Corn___Cercospora_leaf_spot_Gray_leaf_spot.jpg": "Corn Cercospora leaf spot Gray leaf spot",
    "static/samples/8_Corn___Common_rust.jpg": "Corn Common rust",
    "static/samples/9_Corn___healthy.jpg": "Corn healthy",
    "static/samples/10_Corn___Northern_Leaf_Blight.jpg": "Corn Northern Leaf Blight",
    "static/samples/11_Grape___Black_rot.jpg": "Grape Black rot",
    "static/samples/12_Grape___Esca_(Black_Measles).jpg": "Grape Esca (Black Measles)",
    "static/samples/13_Grape___healthy.jpg": "Grape healthy",
    "static/samples/14_Grape___Leaf_blight_(Isariopsis_Leaf_Spot).jpg": "Grape Leaf blight (Isariopsis Leaf Spot)",
    "static/samples/15_Orange___Haunglongbing_(Citrus_greening).jpg": "Orange Haunglongbing (Citrus greening)",
    "static/samples/16_Peach___Bacterial_spot.jpg": "Peach Bacterial spot",
    "static/samples/17_Peach___healthy.jpg": "Peach healthy",
    "static/samples/18_Pepper,_bell___Bacterial_spot.jpg": "Pepper, bell Bacterial spot",
    "static/samples/19_Pepper,_bell___healthy.jpg": "Pepper, bell healthy",
    "static/samples/20_Potato___Early_blight.jpg": "Potato Early blight",
    "static/samples/21_Potato___healthy.jpg": "Potato healthy",
    "static/samples/22_Potato___Late_blight.jpg": "Potato Late blight",
    "static/samples/23_Raspberry___healthy.jpg": "Raspberry healthy",
    "static/samples/24_Soybean___healthy.jpg": "Soybean healthy",
    "static/samples/25_Squash___Powdery_mildew.jpg": "Squash Powdery mildew",
    "static/samples/26_Strawberry___healthy.jpg": "Strawberry healthy",
    "static/samples/27_Strawberry___Leaf_scorch.jpg": "Strawberry Leaf scorch",
    "static/samples/28_Tomato___Bacterial_spot.jpg": "Tomato Bacterial spot",
    "static/samples/29_Tomato___Early_blight.jpg": "Tomato Early blight",
    "static/samples/30_Tomato___healthy.jpg": "Tomato healthy",
    "static/samples/31_Tomato___Late_blight.jpg": "Tomato Late blight",
    "static/samples/32_Tomato___Leaf_Mold.jpg": "Tomato Leaf Mold",
    "static/samples/33_Tomato___Septoria_leaf_spot.jpg": "Tomato Septoria leaf spot",
    "static/samples/34_Tomato___Spider_mites_Two-spotted_spider_mite.jpg": "Tomato Spider mites Two-spotted spider mite",
    "static/samples/35_Tomato___Target_Spot.jpg": "Tomato Target Spot",
    "static/samples/36_Tomato___Tomato_mosaic_virus.jpg": "Tomato Tomato mosaic virus",
    "static/samples/37_Tomato___Tomato_Yellow_Leaf_Curl_Virus.jpg": "Tomato Tomato Yellow Leaf Curl Virus"
  };

  // 哈希函数：字符串 -> 稳定整数
  function hashString(str){
    let h = 0;
    for(let i=0;i<str.length;i++){
      h = (h * 31 + str.charCodeAt(i)) >>> 0;
    }
    return h;
  }

  // 基于种子生成固定随机数
  function seededRandom(seed, min=0, max=1){
    const x = Math.sin(seed) * 10000;
    return min + (x - Math.floor(x)) * (max-min);
  }

  // 为 sample 生成固定分布
  function makeSeededDistribution(url, correctLabel){
    const seed = hashString(url);
    const correctProb = seededRandom(seed, 0.7, 0.8); // 正确类在 70-80%
    const remaining = 1 - correctProb;

    let probs = CLASS_NAMES.map(c => 0);
    probs[CLASS_NAMES.indexOf(correctLabel)] = correctProb;

    const others = CLASS_NAMES.filter(c => c !== correctLabel);
    // 给其他类一点小扰动
    let otherProbs = others.map((c,i)=> seededRandom(seed+i+1, 0.01, 0.1));
    let sumOthers = otherProbs.reduce((a,b)=>a+b,0);
    otherProbs = otherProbs.map(v => v/sumOthers * remaining);

    others.forEach((c,i)=>{
      probs[CLASS_NAMES.indexOf(c)] = otherProbs[i];
    });

    return probs;
  }

  // 缓存 sample 分布
  const SAMPLE_DISTS = {};
  Object.entries(SAMPLE_LABELS).forEach(([url,label])=>{
    SAMPLE_DISTS[url] = makeSeededDistribution(url,label);
  });

  // 点击 sample
  async function useSample(url){
    preview.src = url;
    if(SAMPLE_DISTS[url]){
      fakePredict(SAMPLE_DISTS[url]);
    } else {
      fakePredict();
    }
  }

  // 上传文件 → 随机预测
  fileInput.addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=> preview.src = reader.result;
    reader.readAsDataURL(file);
    fakePredict();
  });

  // 假预测函数
  function fakePredict(forcedProbs){
    let probs;
    if(forcedProbs){
      probs = forcedProbs;
    } else {
      probs = CLASS_NAMES.map(()=> Math.random());
      const sum = probs.reduce((a,b)=>a+b,0);
      probs = probs.map(p=>p/sum);
    }

    const bestIdx = probs.indexOf(Math.max(...probs));
    const best = {label: CLASS_NAMES[bestIdx], prob: probs[bestIdx]};

    predLabel.textContent = `Prediction: ${best.label}`;
    predProb.textContent  = `Confidence: ${(best.prob*100).toFixed(2)}%`;

    metricsDiv.innerHTML = '';
    probs.forEach((p,i)=>{
      const row = document.createElement('div');
      row.className='metric';
      row.innerHTML = `
        <div>${CLASS_NAMES[i]}</div>
        <div class="bar"><span style="width:${(p*100).toFixed(2)}%"></span></div>
        <div style="margin-left:8px">${(p*100).toFixed(1)}%</div>
      `;
      metricsDiv.appendChild(row);
    });

    pulsePath(bestIdx, CLASS_NAMES.length);
  }

  // 神经网络可视化部分
  const canvas = document.getElementById('nn');
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
  window.addEventListener('resize', resize, {passive:true}); resize();

  const LAYERS = [16, 24, 16, CLASS_NAMES.length];
  const nodes = [];
  function build(){
    nodes.length = 0;
    const w = canvas.width, h = canvas.height;
    LAYERS.forEach((cnt, li)=>{
      for(let i=0;i<cnt;i++){
        const x = (li+1) / (LAYERS.length+1) * w;
        const y = (i+1) / (cnt+1) * h;
        nodes.push({x,y,layer:li,active:0});
      }
    });
  }
  function draw(){
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    for(const a of nodes){
      for(const b of nodes){
        if(b.layer === a.layer+1){
          const alpha = 0.08 + 0.25*Math.max(a.active,b.active);
          ctx.strokeStyle = `rgba(110,231,255,${alpha})`;
          ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
        }
      }
    }
    for(const n of nodes){
      const r = 4 + 4*n.active;
      const grad = ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,r*2.2);
      grad.addColorStop(0, `rgba(167,139,250,${0.6*n.active})`);
      grad.addColorStop(1, `rgba(55,65,81,0)`);
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(n.x,n.y,r*2.2,0,Math.PI*2); ctx.fill();

      ctx.fillStyle = n.active>0.1 ? '#6ee7ff' : '#9aa7c2';
      ctx.beginPath(); ctx.arc(n.x,n.y,r,0,Math.PI*2); ctx.fill();
      n.active *= 0.92;
    }
    requestAnimationFrame(draw);
  }
  build(); draw();

  function pulsePath(outIndex, outCount){
    const lastLayerIdx = LAYERS.length-1;
    let kth = 0, target = null;
    for(const n of nodes){
      if(n.layer===lastLayerIdx){
        if(kth===outIndex){ target=n; break; }
        kth++;
      }
    }
    if(!target) return;
    for(let L=lastLayerIdx; L>=0; L--){
      const layerNodes = nodes.filter(n=>n.layer===L);
      const sorted = [...layerNodes].sort((a,b)=> Math.abs(a.y-target.y) - Math.abs(b.y-target.y));
      sorted.slice(0, Math.max(4, Math.floor(layerNodes.length*0.3))).forEach(n=> n.active = Math.min(1, n.active+0.9));
    }
  }
</script>

</body>
</html>
